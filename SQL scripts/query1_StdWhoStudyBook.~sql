WITH StdAtRav AS (SELECT stdid, Name ,Rav.ravid FROM Student INNER JOIN Rav ON Student.ravid = Rav.ravid),
StdLearnBook AS
(
     SELECT Studies.bookid, Book.Name AS bookName, Studies.stdid, Student.Name As StudentName FROM Studies INNER JOIN Student ON Student.Stdid = Studies.Stdid INNER JOIN Book ON Studies.Bookid = Book.bookid
     UNION
     SELECT Teaches.bookid, Book.Name AS bookName, stdid, StdAtRav.Name As StudentName FROM StdAtRav INNER JOIN Teaches ON StdAtRav.ravid = Teaches.ravid INNER JOIN Book ON Teaches.Bookid = Book.bookid
)

SELECT bookid, bookname, LISTAGG(stdid || ' ' || StudentName,',') WITHIN GROUP (ORDER BY stdid) AS StudentLearning
FROM StdLearnBook GROUP BY bookid, bookname
 
      
